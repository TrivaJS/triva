name: Benchmarks

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmarks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Run cache benchmarks
        continue-on-error: true
        timeout-minutes: 5
        run: npm run benchmark:cache 2>&1 | tee cache.log

      - name: Run routing benchmarks
        continue-on-error: true
        timeout-minutes: 5
        run: npm run benchmark:routing 2>&1 | tee routing.log

      - name: Run middleware benchmarks
        continue-on-error: true
        timeout-minutes: 5
        run: npm run benchmark:middleware 2>&1 | tee middleware.log

      - name: Run throttle benchmarks
        continue-on-error: true
        timeout-minutes: 5
        run: npm run benchmark:throttle 2>&1 | tee throttle.log

      - name: Run logging benchmarks
        continue-on-error: true
        timeout-minutes: 5
        run: npm run benchmark:logging 2>&1 | tee logging.log

      - name: Run HTTP benchmarks
        continue-on-error: true
        timeout-minutes: 5
        run: npm run benchmark:http 2>&1 | tee http.log

      # Emit annotations (always run)
      - name: Emit benchmark annotations
        if: always()
        run: |
          echo "::notice::Benchmarks completed"
          echo "::notice::Results available for: cache, routing, middleware, throttle, logging, http"

      # Comment on PR with summary
      - name: Comment benchmark results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const benchmarks = [
              { name: 'Cache', file: 'cache.log' },
              { name: 'Routing', file: 'routing.log' },
              { name: 'Middleware', file: 'middleware.log' },
              { name: 'Throttle', file: 'throttle.log' },
              { name: 'Logging', file: 'logging.log' },
              { name: 'HTTP', file: 'http.log' }
            ];

            let body = '## âš¡ Benchmark Results\n\n';

            for (const bench of benchmarks) {
              body += '### ' + bench.name + '\n';
              
              try {
                const content = fs.readFileSync(bench.file, 'utf8');
                const truncated = content.length > 20000 ? content.slice(0, 20000) + '\n... (truncated)' : content;
                body += '```\n' + truncated + '\n```\n\n';
              } catch (e) {
                body += '```\nNo results found\n```\n\n';
              }
            }

            body += '---\n*Benchmarks run on Ubuntu Latest with Node.js 20*';

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });


      # Upload benchmark results as artifacts
      - name: Upload benchmark artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            cache.log
            routing.log
            middleware.log
            throttle.log
            logging.log
            http.log
          retention-days: 30
