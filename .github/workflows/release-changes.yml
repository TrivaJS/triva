name: Release Changelog

# Generates a changelog comment on every PR update.
# One comment per PR â€” always edited, never duplicated.
# Benchmark results live in a separate workflow (release-benchmarks.yml).
on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read
  pull-requests: write

jobs:
  changelog-write:
    name: Write Changelog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR title
        id: pr-info
        run: |
          PR_TITLE=$(gh pr view ${{ github.event.pull_request.number }} --json title --jq '.title')
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Get PR commits
        id: commits
        run: |
          COMMITS=$(gh pr view ${{ github.event.pull_request.number }} --json commits --jq '.commits[].oid')
          {
            echo "commits<<EOF"
            echo "$COMMITS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Generate changelog
        id: changelog
        run: |
          NOTABLE_CHANGES=""
          ALL_COMMITS=""

          while IFS= read -r commit_sha; do
            [ -z "$commit_sha" ] && continue

            COMMIT_MSG=$(git log --format=%s -n 1 "$commit_sha")
            COMMIT_DATE=$(git log --format=%cs -n 1 "$commit_sha")
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r "$commit_sha")

            NOTABLE=false
            while IFS= read -r file; do
              if [[ "$file" == lib/* || "$file" == types/* || "$file" == extensions/* ]]; then
                NOTABLE=true; break
              fi
            done <<< "$CHANGED_FILES"

            COMMIT_URL="https://github.com/${{ github.repository }}/commit/$commit_sha"
            SHORT_SHA="${commit_sha:0:7}"
            ENTRY="- [[\`$SHORT_SHA\`]($COMMIT_URL)] - $COMMIT_MSG **($COMMIT_DATE)**"

            ALL_COMMITS="$ALL_COMMITS
          $ENTRY"
            [ "$NOTABLE" = true ] && NOTABLE_CHANGES="$NOTABLE_CHANGES
          $ENTRY"

          done <<< "${{ steps.commits.outputs.commits }}"

          CHANGELOG="## Version ${{ steps.pr-info.outputs.pr_title }} Release"

          if [ -n "$NOTABLE_CHANGES" ]; then
            CHANGELOG="$CHANGELOG

          ### Notable Changes$NOTABLE_CHANGES"
          fi

          CHANGELOG="$CHANGELOG

          ### All Commits$ALL_COMMITS"

          echo "$CHANGELOG" > changelog.md

          {
            echo 'changelog<<EOF'
            cat changelog.md
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ github.event.pull_request.number }}-changelog
          path: changelog.md
          retention-days: 90

      - name: Find existing changelog comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Version'

      - name: Create or update changelog comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ${{ steps.changelog.outputs.changelog }}

            ---
            ðŸ“¥ [Download Changelog](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            *Last updated: ${{ github.event.pull_request.updated_at }}*
