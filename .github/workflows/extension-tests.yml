name: Extension Compatibility Tests

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-extensions:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        extension:
          - cors
          - cli
          - shortcuts

    steps:
      - name: Checkout main package
        uses: actions/checkout@v4
        with:
          path: triva

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install main package dependencies
        working-directory: ./triva
        run: npm install

      - name: Pack main package
        working-directory: ./triva
        run: |
          # Create tarball of current triva version
          npm pack
          # Move to parent directory for extensions to use
          mv triva-*.tgz ../triva-local.tgz

      - name: Checkout extension
        uses: actions/checkout@v4
        with:
          repository: trivajs/${{ matrix.extension }}
          path: extensions/${{ matrix.extension }}
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Check if extension exists
        id: check-extension
        run: |
          if [ -d "extensions/${{ matrix.extension }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install extension dependencies
        if: steps.check-extension.outputs.exists == 'true'
        working-directory: ./extensions/${{ matrix.extension }}
        run: |
          # Don't run npm install yet - it will fail on peer dependencies
          # Instead, manually install the local triva package first

          # Create node_modules if it doesn't exist
          mkdir -p node_modules

          # Extract and install local triva
          cd node_modules
          tar -xzf ../../../triva-local.tgz
          mv package triva
          cd ..

          # Now install other dependencies, ignoring peer dependency warnings
          npm install --legacy-peer-deps || true

      - name: Create snippets directory for shortcuts
        if: steps.check-extension.outputs.exists == 'true' && matrix.extension == 'shortcuts'
        run: |
          mkdir -p snippets
          echo '{}' > snippets/triva.json

      - name: Test extension compatibility
        if: steps.check-extension.outputs.exists == 'true'
        working-directory: ./extensions/${{ matrix.extension }}
        run: |
          # Run extension tests if they exist
          if [ -f "package.json" ] && grep -q '"test":' package.json && ! grep -q '"test": *""' package.json; then
            npm test
          else
            echo "✅ No tests defined for ${{ matrix.extension }}"
          fi

      - name: Integration test
        if: steps.check-extension.outputs.exists == 'true'
        run: |
          # Create integration test script
          cat > integration-test.js << 'EOF'
          import { build, get, listen } from './triva/lib/index.js';

          async function testExtension() {
            const extensionName = process.env.EXTENSION_NAME;

            // Test importing extension
            let extension;
            try {
              const modulePath = `./extensions/${extensionName}/lib/index.js`;
              const moduleUrl = new URL(modulePath, import.meta.url);
              extension = await import(moduleUrl.href);
              console.log(`✅ Successfully imported @trivajs/${extensionName}`);
            } catch (error) {
              console.error(`❌ Failed to import extension:`, error.message);
              process.exit(1);
            }

            // Test basic server with extension
            try {
              await build({
                env: 'test',
                cache: { type: 'memory' }
              });

              get('/', (req, res) => {
                res.json({ test: 'ok' });
              });

              console.log(`✅ Server built successfully with ${extensionName} loaded`);
              process.exit(0);
            } catch (error) {
              console.error('❌ Failed to build server:', error.message);
              process.exit(1);
            }
          }

          testExtension();
          EOF

          EXTENSION_NAME=${{ matrix.extension }} node integration-test.js

      - name: Report extension not found
        if: steps.check-extension.outputs.exists == 'false'
        run: |
          echo "⏭️  Extension repository @trivajs/${{ matrix.extension }} not found or not accessible"
          echo "   Create repository at: https://github.com/trivajs/${{ matrix.extension }}"
          exit 0

      - name: Report status
        if: always()
        run: |
          if [ "${{ steps.check-extension.outputs.exists }}" == "false" ]; then
            echo "⏭️  Extension @trivajs/${{ matrix.extension }} - repository not found"
          elif [ ${{ job.status }} == 'success' ]; then
            echo "✅ Extension @trivajs/${{ matrix.extension }} is compatible"
          else
            echo "❌ Extension @trivajs/${{ matrix.extension }} compatibility failed"
          fi

  test-all-extensions-together:
    runs-on: ubuntu-latest
    needs: test-extensions
    if: always()

    steps:
      - name: Checkout main package
        uses: actions/checkout@v4
        with:
          path: triva

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and pack main package
        working-directory: ./triva
        run: |
          npm install
          npm pack
          mv triva-*.tgz ../triva-local.tgz

      - name: Checkout all extensions
        continue-on-error: true
        run: |
          mkdir -p extensions
          cd extensions

          # Clone each extension
          for ext in cors cli shortcuts; do
            git clone https://github.com/trivajs/$ext.git $ext 2>/dev/null || echo "⚠️  Could not clone $ext"
          done

      - name: Count available extensions
        id: count
        run: |
          count=0
          for ext in cors cli shortcuts; do
            if [ -d "extensions/$ext" ]; then
              count=$((count + 1))
            fi
          done
          echo "available=$count" >> $GITHUB_OUTPUT

      - name: Install all extensions
        if: steps.count.outputs.available > 0
        run: |
          for ext in cors cli shortcuts; do
            if [ -d "extensions/$ext" ]; then
              echo "Installing $ext..."
              cd extensions/$ext

              # Create node_modules and install local triva
              mkdir -p node_modules
              cd node_modules
              tar -xzf ../../../triva-local.tgz
              mv package triva
              cd ..

              # Install other dependencies
              npm install --legacy-peer-deps || true

              cd ../..
            fi
          done

      - name: Create snippets directory
        if: steps.count.outputs.available > 0
        run: |
          mkdir -p snippets
          echo '{}' > snippets/triva.json

      - name: Test all extensions together
        if: steps.count.outputs.available > 0
        run: |
          cat > test-all.js << 'EOF'
          import { build, get, listen } from './triva/lib/index.js';

          async function testAllExtensions() {
            console.log('Testing all extensions together...');

            const extensions = ['cors', 'cli', 'shortcuts'];
            const loaded = [];

            for (const ext of extensions) {
              try {
                const modulePath = `./extensions/${ext}/lib/index.js`;
                const moduleUrl = new URL(modulePath, import.meta.url);
                await import(moduleUrl.href);
                loaded.push(ext);
                console.log(`✅ Loaded @trivajs/${ext}`);
              } catch (error) {
                console.log(`⚠️  Could not load @trivajs/${ext}: ${error.message}`);
              }
            }

            // Build server with all extensions available
            await build({
              env: 'test',
              cache: { type: 'memory' }
            });

            get('/test', (req, res) => {
              res.json({ extensions: loaded });
            });

            console.log(`✅ Successfully loaded ${loaded.length}/${extensions.length} extensions`);

            if (loaded.length > 0) {
              console.log('✅ All available extensions compatible!');
              process.exit(0);
            } else {
              console.log('⚠️  No extensions could be loaded');
              process.exit(0);
            }
          }

          testAllExtensions().catch(error => {
            console.error('❌ Test failed:', error);
            process.exit(1);
          });
          EOF

          node test-all.js

      - name: Skip if no extensions
        if: steps.count.outputs.available == 0
        run: |
          echo "⏭️  No extension repositories found - skipping combined test"
          echo "   Extension repositories need to be created first"

      - name: Summary
        if: always()
        run: |
          echo "## Extension Compatibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Extension | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Check which extensions exist
          for ext in cors cli shortcuts; do
            if [ -d "extensions/$ext" ]; then
              if [ ${{ job.status }} == 'success' ]; then
                echo "| @trivajs/$ext | ✅ Compatible |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| @trivajs/$ext | ⚠️  Check logs |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| @trivajs/$ext | ⏭️  Not found |" >> $GITHUB_STEP_SUMMARY
            fi
          done
