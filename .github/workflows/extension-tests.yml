name: Extension Compatibility Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-extensions:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        extension:
          - cors
          - cli
          - shortcuts
    
    steps:
      - name: Checkout main package
        uses: actions/checkout@v4
        with:
          path: triva
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install main package dependencies
        working-directory: ./triva
        run: npm install
      
      - name: Build main package
        working-directory: ./triva
        run: |
          # Link package globally for extensions to use
          npm link
      
      - name: Checkout extension
        uses: actions/checkout@v4
        with:
          repository: trivajs/${{ matrix.extension }}
          path: extensions/${{ matrix.extension }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install extension dependencies
        working-directory: ./extensions/${{ matrix.extension }}
        run: |
          npm install
          # Link to local triva package
          npm link triva
      
      - name: Test extension compatibility
        working-directory: ./extensions/${{ matrix.extension }}
        run: |
          # Run extension tests if they exist
          if [ -f "package.json" ] && grep -q '"test":' package.json; then
            npm test
          else
            echo "No tests found for ${{ matrix.extension }}"
          fi
      
      - name: Integration test
        run: |
          # Create integration test script
          cat > integration-test.js << 'EOF'
          import { build, get, listen } from 'triva';
          
          // Test importing extension
          let extension;
          try {
            const extensionName = process.env.EXTENSION_NAME;
            const modulePath = `./extensions/${extensionName}/lib/index.js`;
            extension = await import(modulePath);
            console.log(`✅ Successfully imported @trivajs/${extensionName}`);
          } catch (error) {
            console.error(`❌ Failed to import extension:`, error.message);
            process.exit(1);
          }
          
          // Test basic server with extension
          try {
            await build({
              env: 'test',
              cache: { type: 'memory' }
            });
            
            get('/', (req, res) => {
              res.json({ test: 'ok' });
            });
            
            console.log('✅ Server built successfully with extension loaded');
            process.exit(0);
          } catch (error) {
            console.error('❌ Failed to build server:', error.message);
            process.exit(1);
          }
          EOF
          
          EXTENSION_NAME=${{ matrix.extension }} node integration-test.js
      
      - name: Report status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Extension @trivajs/${{ matrix.extension }} is compatible"
          else
            echo "❌ Extension @trivajs/${{ matrix.extension }} compatibility failed"
          fi
  
  test-all-extensions-together:
    runs-on: ubuntu-latest
    needs: test-extensions
    
    steps:
      - name: Checkout main package
        uses: actions/checkout@v4
        with:
          path: triva
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install and link main package
        working-directory: ./triva
        run: |
          npm install
          npm link
      
      - name: Checkout all extensions
        run: |
          mkdir -p extensions
          cd extensions
          
          # Clone each extension
          for ext in cors cli shortcuts; do
            git clone https://github.com/trivajs/$ext.git $ext || echo "Failed to clone $ext"
          done
      
      - name: Install all extensions
        run: |
          for ext in cors cli shortcuts; do
            if [ -d "extensions/$ext" ]; then
              cd extensions/$ext
              npm install
              npm link triva
              cd ../..
            fi
          done
      
      - name: Test all extensions together
        run: |
          cat > test-all.js << 'EOF'
          import { build, get, listen } from 'triva';
          
          async function testAllExtensions() {
            console.log('Testing all extensions together...');
            
            const extensions = ['cors', 'cli', 'shortcuts'];
            const loaded = [];
            
            for (const ext of extensions) {
              try {
                const modulePath = `./extensions/${ext}/lib/index.js`;
                await import(modulePath);
                loaded.push(ext);
                console.log(`✅ Loaded @trivajs/${ext}`);
              } catch (error) {
                console.error(`⚠️  Could not load @trivajs/${ext}:`, error.message);
              }
            }
            
            // Build server with all extensions available
            await build({
              env: 'test',
              cache: { type: 'memory' }
            });
            
            get('/test', (req, res) => {
              res.json({ extensions: loaded });
            });
            
            console.log(`✅ Successfully loaded ${loaded.length}/${extensions.length} extensions`);
            
            if (loaded.length === extensions.length) {
              console.log('✅ All extensions compatible!');
              process.exit(0);
            } else {
              console.log('⚠️  Some extensions could not be loaded');
              process.exit(0); // Don't fail, just warn
            }
          }
          
          testAllExtensions().catch(error => {
            console.error('❌ Test failed:', error);
            process.exit(1);
          });
          EOF
          
          node test-all.js
      
      - name: Summary
        if: always()
        run: |
          echo "## Extension Compatibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Extension | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ ${{ job.status }} == 'success' ]; then
            echo "| @trivajs/cors | ✅ Compatible |" >> $GITHUB_STEP_SUMMARY
            echo "| @trivajs/cli | ✅ Compatible |" >> $GITHUB_STEP_SUMMARY
            echo "| @trivajs/shortcuts | ✅ Compatible |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Some extensions | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
