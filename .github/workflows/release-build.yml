name: Release Build Constructor

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

jobs:
  package-core:
    name: Package Core Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Pack core package
        run: |
          npm pack
          mkdir -p build
          mv triva-*.tgz build/triva-core.tgz
      
      - name: Upload core package
        uses: actions/upload-artifact@v4
        with:
          name: triva-core-package
          path: build/triva-core.tgz
          retention-days: 90
      
      - name: Get package info
        id: package-info
        run: |
          PACKAGE_SIZE=$(ls -lh build/triva-core.tgz | awk '{print $5}')
          echo "size=$PACKAGE_SIZE" >> $GITHUB_OUTPUT
      
      - name: Comment on PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ inputs.pr_number }}
          body: |
            ## üì¶ Core Package Built
            
            **Package:** `triva-core.tgz`  
            **Size:** ${{ steps.package-info.outputs.size }}  
            **Download:** [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
  
  package-extensions:
    name: Package Extensions
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        extension:
          - cors
          - cli
          - shortcuts
    
    steps:
      - name: Checkout extension
        uses: actions/checkout@v4
        with:
          repository: trivajs/${{ matrix.extension }}
          path: ${{ matrix.extension }}
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Check if extension exists
        id: check
        run: |
          if [ -d "${{ matrix.extension }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Node.js
        if: steps.check.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        if: steps.check.outputs.exists == 'true'
        working-directory: ./${{ matrix.extension }}
        run: npm install --legacy-peer-deps || true
      
      - name: Pack extension
        if: steps.check.outputs.exists == 'true'
        working-directory: ./${{ matrix.extension }}
        run: |
          npm pack
          mkdir -p ../build
          mv trivajs-${{ matrix.extension }}-*.tgz ../build/trivajs-${{ matrix.extension }}.tgz || \
          mv ${{ matrix.extension }}-*.tgz ../build/trivajs-${{ matrix.extension }}.tgz || \
          echo "Package name pattern not matched"
      
      - name: Upload extension package
        if: steps.check.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: trivajs-${{ matrix.extension }}-package
          path: build/trivajs-${{ matrix.extension }}.tgz
          retention-days: 90
      
      - name: Get package info
        if: steps.check.outputs.exists == 'true'
        id: package-info
        run: |
          if [ -f "build/trivajs-${{ matrix.extension }}.tgz" ]; then
            PACKAGE_SIZE=$(ls -lh build/trivajs-${{ matrix.extension }}.tgz | awk '{print $5}')
            echo "size=$PACKAGE_SIZE" >> $GITHUB_OUTPUT
            echo "built=true" >> $GITHUB_OUTPUT
          else
            echo "built=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Report extension not found
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "‚è≠Ô∏è  Extension @trivajs/${{ matrix.extension }} not found"
  
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [package-core, package-extensions]
    if: always()
    
    steps:
      - name: Create summary comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ inputs.pr_number }}
          body: |
            ## üì¶ Release Build Packages
            
            ### Core Package
            - ‚úÖ `triva-core.tgz` - Built successfully
            
            ### Extension Packages
            - ${{ needs.package-extensions.result == 'success' && '‚úÖ' || '‚è≠Ô∏è' }} `@trivajs/cors`
            - ${{ needs.package-extensions.result == 'success' && '‚úÖ' || '‚è≠Ô∏è' }} `@trivajs/cli`
            - ${{ needs.package-extensions.result == 'success' && '‚úÖ' || '‚è≠Ô∏è' }} `@trivajs/shortcuts`
            
            ---
            üì• **Download all packages:** [Workflow Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            *Built at: ${{ github.event.repository.updated_at }}*
