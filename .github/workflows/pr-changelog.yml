name: PR Changelog Generator

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  pull-requests: write
  contents: read

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR info
        id: pr-info
        run: |
          PR_TITLE=$(gh pr view ${{ github.event.pull_request.number }} --json title --jq '.title')
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Get PR commits
        id: commits
        run: |
          # Get all commits in this PR
          COMMITS=$(gh pr view ${{ github.event.pull_request.number }} --json commits --jq '.commits[].oid')
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Generate changelog
        id: changelog
        run: |
          # Initialize changelog sections
          NOTABLE_CHANGES=""
          ALL_COMMITS=""
          
          # Process each commit
          while IFS= read -r commit_sha; do
            if [ -z "$commit_sha" ]; then
              continue
            fi
            
            # Get commit info
            COMMIT_MSG=$(git log --format=%s -n 1 $commit_sha)
            COMMIT_DATE=$(git log --format=%cs -n 1 $commit_sha)
            
            # Get changed files
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r $commit_sha)
            
            # Check if this is a notable change
            NOTABLE=false
            while IFS= read -r file; do
              if [[ "$file" == lib/* ]] || [[ "$file" == types/* ]] || [[ "$file" == extensions/* ]] || [[ "$file" == submodules/* ]]; then
                NOTABLE=true
                break
              fi
            done <<< "$CHANGED_FILES"
            
            # Build changelog entry
            COMMIT_URL="https://github.com/${{ github.repository }}/commit/$commit_sha"
            SHORT_SHA="${commit_sha:0:7}"
            ENTRY="- [[\`\`$SHORT_SHA\`\`]($COMMIT_URL)] - $COMMIT_MSG **($COMMIT_DATE)**"
            
            # Add to all commits
            ALL_COMMITS="$ALL_COMMITS
          $ENTRY"
            
            # Add to notable if applicable
            if [ "$NOTABLE" = true ]; then
              NOTABLE_CHANGES="$NOTABLE_CHANGES
          $ENTRY"
            fi
          done <<< "${{ steps.commits.outputs.commits }}"
          
          # Build complete changelog
          CHANGELOG="## Version ${{ steps.pr-info.outputs.pr_title }} Release"
          
          if [ ! -z "$NOTABLE_CHANGES" ]; then
            CHANGELOG="$CHANGELOG

          ### Notable Changes$NOTABLE_CHANGES"
          fi
          
          CHANGELOG="$CHANGELOG

          ### All Commits$ALL_COMMITS"
          
          # Save to file for comment
          echo "$CHANGELOG" > changelog.md
          
          # Save for output (escape newlines for GitHub Actions)
          {
            echo 'changelog<<EOF'
            cat changelog.md
            echo EOF
          } >> $GITHUB_OUTPUT
      
      - name: Upload changelog as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ github.event.pull_request.number }}-changelog
          path: changelog.md
          retention-days: 90
      
      - name: Find existing changelog comment
        id: find-comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Version'
      
      - name: Create or update changelog comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ${{ steps.changelog.outputs.changelog }}
            
            ---
            ðŸ“¥ [Download full changelog](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          edit-mode: replace
