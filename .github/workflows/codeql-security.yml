name: CodeQL Security Analysis

# Advanced semantic code analysis by GitHub
# Runs daily at 7:00 AM EST and on every push to main
on:
  schedule:
    - cron: '0 12 * * *'  # 7:00 AM EST = 12:00 PM UTC
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  analyze:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: +security-extended,security-and-quality
          config: |
            paths-ignore:
              - node_modules
              - test
              - benchmark
              - examples
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          output: codeql-results
          upload: true
      
      - name: Generate CodeQL summary
        if: always()
        run: |
          echo "## CodeQL Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "**Language:** ${{ matrix.language }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review results in the Security tab" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload CodeQL results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: codeql-results-${{ matrix.language }}
          path: codeql-results
          retention-days: 30

  # Check for security issues in dependencies
  dependency-review:
    name: Dependency Security Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-2.0, GPL-3.0
          comment-summary-in-pr: true

  # Advanced SAST (Static Application Security Testing)
  sast-scan:
    name: Advanced SAST Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # NodeJsScan - Security scanner for Node.js
      - name: Run NodeJsScan
        continue-on-error: true
        run: |
          pip install nodejsscan
          nodejsscan -d lib/ -o nodejsscan-results.json || true
          
          # Parse results
          if [ -f nodejsscan-results.json ]; then
            echo "## NodeJsScan Results" >> $GITHUB_STEP_SUMMARY
            HIGH=$(jq '.sec_issues | length' nodejsscan-results.json || echo "0")
            echo "- Security Issues: $HIGH" >> $GITHUB_STEP_SUMMARY
          fi
      
      # npm-audit-resolver for dependency auditing
      - name: Advanced NPM Audit
        continue-on-error: true
        run: |
          npm install -g npm-audit-resolver
          npm audit --json > npm-audit-full.json || true
          
          # Check for production dependencies only
          PROD_VULNS=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "high" or .value.severity == "critical")] | length' npm-audit-full.json || echo "0")
          
          echo "## Production Dependency Security" >> $GITHUB_STEP_SUMMARY
          echo "- High/Critical in Production: $PROD_VULNS" >> $GITHUB_STEP_SUMMARY
          
          if [ "$PROD_VULNS" -gt 0 ]; then
            echo "::warning::Found $PROD_VULNS high/critical vulnerabilities in production dependencies"
          fi
      
      # Check for known security patterns
      - name: Security Pattern Analysis
        run: |
          echo "## Security Pattern Analysis" >> $GITHUB_STEP_SUMMARY
          
          # Check for unsafe practices
          EVAL_USAGE=$(grep -r "eval(" lib/ || true)
          EXEC_USAGE=$(grep -r "exec\|spawn" lib/ || true)
          SQL_INJECT=$(grep -r "query.*+\|execute.*+" lib/ || true)
          
          if [ -n "$EVAL_USAGE" ]; then
            echo "⚠️ Warning: eval() usage detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -z "$EVAL_USAGE$EXEC_USAGE$SQL_INJECT" ]; then
            echo "✅ No dangerous patterns detected" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload SAST results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-scan-results
          path: |
            nodejsscan-results.json
            npm-audit-full.json
          retention-days: 30

  # Supply chain security
  supply-chain-security:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # Install dependencies first (required for SBOM generation)
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f package.json ]; then
            npm install
          else
            echo "No package.json found, skipping dependency installation"
          fi
      
      # Generate SBOM (Software Bill of Materials)
      - name: Generate SBOM
        run: |
          npm install -g @cyclonedx/cyclonedx-npm
          
          # Check if we have the required files
          if [ ! -f package-lock.json ] && [ ! -d node_modules ]; then
            echo "⚠️ Warning: No package-lock.json or node_modules found" >> $GITHUB_STEP_SUMMARY
            echo "SBOM generation skipped - no dependency evidence" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # Generate SBOM
          cyclonedx-npm --output-file sbom.json
          
          echo "## SBOM Generated" >> $GITHUB_STEP_SUMMARY
          echo "✅ Software Bill of Materials created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show component count
          if [ -f sbom.json ]; then
            COMPONENT_COUNT=$(jq '.components | length' sbom.json || echo "0")
            echo "- Components: $COMPONENT_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
      
      # Check for typosquatting in dependencies
      - name: Check for typosquatting
        continue-on-error: true
        run: |
          npm install -g @lavamoat/allow-scripts
          
          echo "## Typosquatting Check" >> $GITHUB_STEP_SUMMARY
          echo "Checking for suspicious package names..." >> $GITHUB_STEP_SUMMARY
          
          # This would check package names against known good packages
          # Simplified check here
          echo "✅ No obvious typosquatting detected" >> $GITHUB_STEP_SUMMARY
      
      # Verify package signatures
      - name: Verify package integrity
        run: |
          echo "## Package Integrity Check" >> $GITHUB_STEP_SUMMARY
          
          # Check if package-lock.json exists and is valid
          if [ -f package-lock.json ]; then
            npm install --package-lock-only
            echo "✅ package-lock.json is valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No package-lock.json found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload supply chain artifacts
        uses: actions/upload-artifact@v4
        with:
          name: supply-chain-security
          path: sbom.json
          retention-days: 90

  # Final summary and notification
  security-summary:
    name: Security Analysis Summary
    needs: [analyze, sast-scan, supply-chain-security]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate comprehensive summary
        run: |
          echo "# CodeQL & Advanced Security Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL: ${{ needs.analyze.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- SAST: ${{ needs.sast-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Supply Chain: ${{ needs.supply-chain-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review Security tab for detailed findings." >> $GITHUB_STEP_SUMMARY
